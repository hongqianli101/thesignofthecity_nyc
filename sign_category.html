<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sign Category</title>
    <link rel="icon" type="image/png" href="images/do not enter sign.png">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        *{
            margin-top: 1px;
            padding: 0;
        }
        body {
            background-color: black;
            color: white;
            font-family: Arial, Helvetica, sans-serif;
        }
        body::-webkit-scrollbar {
            display: none; /* 对Chrome和Safari有效 */
        }
        .checkboxes label {
            margin-right: 10px;
        }
        #checkboxes {
            margin-bottom: 20px;
        }
        .chart-container {
            display: inline-block;
            margin: 5px;
            margin-bottom: 15px;
            width: 120px;
            text-align: center;
        }
        .chart-title {
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            word-wrap: break-word;
            margin-top: 5px;
            height: 30px;
            overflow: hidden;
        }
        svg {
            display: block;
            height: 120px;
        }
        text {
            fill: white;
            font-size: 12px;
            text-anchor: middle;
        }
        h1 {
            color: white;
            margin: 5px;
            font-size: 32px;
        }
        h1 a {
            text-decoration: none;
            color: white;
        }
        .menu {
            margin-top: 1px;
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items:center;
        }
        #rightmenu {
            margin-right: 3px;
        }
        #rightmenu a {
            text-decoration: none;
            color: white;
            font-size: 18px;
            font-family: Arial, Helvetica, sans-serif;
            margin: 10px;
        }
        span {
            color: white;
        }
        .label-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: bottom;
            margin: 5px;
            font-size: 12px;
        }
        .label-container > div {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .label-container input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border: 1px solid white;
            border-radius: 2px;
            background-color: transparent;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }
        .label-container input[type="checkbox"]:checked {
            background-color: var(--checkbox-color);
        }
        .label-container input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
        }
        .btn-container {
            display: inline-flex;
            flex-direction: row;
            align-items: flex-end;
            vertical-align: bottom;
            margin: 5px;
            font-size: 12px;
            gap: 10px;
        }
        .btn-container button {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            border-radius: 2px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-container button:hover {
            background-color: #333;
        }
    </style>
</head>
<body>
    <div class="menu">
        <div id="leftmenu">
            <h1><a href="application.html">The Sign of the City</a></h1>
        </div>
        <div id="rightmenu">
            <a href="index.html">About</a>
            <span>‧</span>
            <a href="sign_category.html">Sign Category</a>
            <span>‧</span>
            <a href="sign_language.html">Sign Language</a>
            <span>‧</span>
            <a href="sign_content.html">Sign Content</a>
        </div>
        </div>
    <div id="checkboxes" class="checkboxes"></div>
<script>
const csvFilePath = 'route-data-overall_final_subweb.csv';
const languageColors = {
    'brand sign': '#e81e63',
    'street name sign': '#9c27b0',
    'building information sign': '#3f51b5',
    'bus stop sign': '#03a9f4',
    'parking regulation sign': '#00bcd4',
    'scaffold sign': '#009688',
    'one way sign': '#8bc34a',
    'advertising sign': '#cddc39',
    'for lease sign': '#ffc107',
    'do not enter sign': '#ff9800',
    'speed limit sign': '#ff5722',
    'promotion sign': '#795548',
    'direction sign': '#9e9e9e',
    'subway sign': '#607d8b',
    'touristic sign': '#a77be0',
    'shop information sign': '#d128f1',
    'street close sign': '#fe9353',
    'school crossing sign': '#5512d9',
    'all traffic sign': '#a16f67',
    'dont block sign': '#6f4e62'
};

d3.csv(csvFilePath).then(function(data) {
    let expandedData = data.flatMap(d => 
        d['Category'].split(';').map(language => ({...d, 'Language': language.trim()}))
    );

        // 使用Set来收集唯一的社区名称
        let communityNames = new Set(expandedData.map(d => d.NTAName));

// 将所有社区名称转换为数组并打印
console.log(Array.from(communityNames));

    // 生成复选框
    const languages = Object.keys(languageColors);
    const checkboxesDiv = d3.select("#checkboxes");
        languages.forEach(language => {
            const label = checkboxesDiv.append("div")  // 使用 div 代替 label，因为我们要自定义布局
                .attr("class", "label-container");  // 应用刚才定义的 CSS 类

            const imagePath = `images/${language.toLowerCase()}.png`;

            label.append("img")
                .attr("src", imagePath)
                .attr("alt", `${language} logo`)
                .style("height", "20px")
                .style("display", "block");

            const inputContainer = label.append("div");  // 为复选框和文字创建一个新的 div 容器

            inputContainer.append("input")
                .attr("type", "checkbox")
                .attr("value", language)
                .attr("checked", true)
                .style("--checkbox-color", languageColors[language])
                .on("change", () => drawCharts(expandedData, languageColors));

            inputContainer.append("span")
                .text(language);
        });

        // 添加 Select All 和 Deselect All 按钮
        const btnContainer = checkboxesDiv.append("div")
            .attr("class", "btn-container");

        btnContainer.append("button")
            .text("Select All")
            .on("click", () => {
                d3.selectAll("#checkboxes input[type=checkbox]").property("checked", true);
                drawCharts(expandedData, languageColors);
            });

        btnContainer.append("button")
            .text("Deselect All")
            .on("click", () => {
                d3.selectAll("#checkboxes input[type=checkbox]").property("checked", false);
                drawCharts(expandedData, languageColors);
            });

    drawCharts(expandedData, languageColors);
});

function drawCharts(expandedData, languageColors) {
    // 获取所有选中的语言
    const selectedLanguages = [];
    d3.selectAll("#checkboxes input[type=checkbox]:checked").each(function() {
        selectedLanguages.push(this.value);
    });

    // 清除旧的图表容器
    d3.selectAll(".chart-container").remove();

    // 使用预定义的社区列表来保证所有社区都会被渲染
    const predefinedCommunities = [
        "Midtown-Times Square",
        "Midtown South-Flatiron-Union Square",
        "Greenwich Village",
        "East Village",
        "SoHo-Little Italy-Hudson Square",
        "Lower East Side",
        "Chinatown-Two Bridges",
        "Downtown Brooklyn-DUMBO-Boerum Hill",
        "Fort Greene",
        "Park Slope",
        "Prospect Heights",
        "Prospect Park",
        "Prospect Lefferts Gardens-Wingate",
        "Flatbush",
        "East Flatbush-Erasmus",
        "Holy Cross Cemetery",
        "East Flatbush-Rugby",
        "East Flatbush-Remsen Village",
        "Brownsville",
        "Ocean Hill",
        "East New York (North)",
        "Cypress Hills",
        "Highland Park-Cypress Hills Cemeteries (South)",
        "Woodhaven",
        "Richmond Hill",
        "Kew Gardens",
        "Jamaica Hills-Briarwood",
        "Kew Gardens Hills",
        "Queensboro Hill",
        "Flushing-Willets Point",
        "Whitestone-Beechhurst",
        "Ferry Point Park-St. Raymond Cemetery",
        "Castle Hill-Unionport",
        "Westchester Square",
        "Parkchester",
        "Pelham Parkway-Van Nest",
        "Morris Park",
        "West Farms",
        "Crotona Park East",
        "Morrisania",
        "Melrose",
        "Mott Haven-Port Morris",
        "East Harlem (North)",
        "East Harlem (South)",
        "Central Park",
        "Upper East Side-Carnegie Hill"
    ];

    predefinedCommunities.forEach((communityName) => {
        let communityData = expandedData.filter(d => d.NTAName === communityName && selectedLanguages.includes(d.Language));

        let languageCounts = d3.rollup(communityData, v => v.length, d => d.Language);

        let stack = [];
        let y0 = 0;
        languageCounts.forEach((count, language) => {
            stack.push({ language, y0, y1: y0 += count });
        });

        const svgHeight = 120;
        const svgWidth = 120;

        // 创建容器
        let container = d3.select('body').append('div')
            .attr('class', 'chart-container');

        // 添加 SVG
        let svg = container.append('svg')
            .attr('width', svgWidth)
            .attr('height', svgHeight)
            .style('background-color', 'black')
            .append('g');

        let rects = svg.selectAll('rect')
            .data(stack, d => d.language);

        // 使用过渡动画更新矩形
        rects.enter().append('rect')
            .attr('x', 0)
            .attr('y', d => svgHeight)
            .attr('width', svgWidth)
            .attr('height', 0)
            .attr('fill', d => languageColors[d.language])
            .merge(rects) // 合并 enter 和 update 选择集
            .transition() // 开始一个过渡
            .duration(1000) // 过渡持续时间
            .attr('y', d => svgHeight - (d.y1 - d.y0))
            .attr('height', d => d.y1 - d.y0);

        // 处理退出的元素
        rects.exit()
            .transition() // 开始一个过渡
            .duration(1000) // 过渡持续时间
            .attr('y', svgHeight)
            .attr('height', 0)
            .remove(); // 在过渡结束时删除元素

        // 添加标题（在 SVG 下方）
        container.append('div')
            .attr('class', 'chart-title')
            .text(communityName);
    });
}
</script>
</body>
</html>
